{% extends 'base.html.twig' %}

{% block title %}Détails du Paiement - ZANDO Market{% endblock %}
{% block header %}Détails du Paiement{% endblock %}
{% block subtitle %}{{ payment.bankingTransactionId ?? 'PAY-' ~ (payment.id|bin2hex|slice(0, 8)|upper) }}{% endblock %}

{% block content %}
<div class="mb-4 flex justify-between items-center">
    <a href="{{ path('market_admin_payments_index') }}" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
        <i class="fas fa-arrow-left mr-2"></i>Retour aux paiements
    </a>
    
    {% if payment.status.value == 'pending' %}
    <div class="flex space-x-3">
        <form method="post" action="{{ path('market_admin_payments_validate', {id: payment.id|bin2hex}) }}" class="inline">
            <input type="hidden" name="_token" value="{{ csrf_token('validate_payment') }}">
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700" onclick="return confirm('Confirmer la validation de ce paiement ?')">
                <i class="fas fa-check mr-2"></i>Valider le paiement
            </button>
        </form>
        <form method="post" action="{{ path('market_admin_payments_reject', {id: payment.id|bin2hex}) }}" class="inline">
            <input type="hidden" name="_token" value="{{ csrf_token('reject_payment') }}">
            <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="return confirm('Rejeter ce paiement ?')">
                <i class="fas fa-times mr-2"></i>Rejeter
            </button>
        </form>
    </div>
    {% endif %}
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Informations principales -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Statut -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Statut du paiement</h3>
                {% if payment.status.value == 'paid' or payment.status.value == 'completed' %}
                    <span class="px-4 py-2 bg-green-100 text-green-800 rounded-full font-semibold">
                        <i class="fas fa-check-circle mr-2"></i>Validé
                    </span>
                {% elseif payment.status.value == 'pending' %}
                    <span class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-full font-semibold">
                        <i class="fas fa-clock mr-2"></i>En attente
                    </span>
                {% elseif payment.status.value == 'failed' %}
                    <span class="px-4 py-2 bg-red-100 text-red-800 rounded-full font-semibold">
                        <i class="fas fa-times-circle mr-2"></i>Rejeté
                    </span>
                {% else %}
                    <span class="px-4 py-2 bg-gray-100 text-gray-800 rounded-full font-semibold">
                        {{ payment.status.value }}
                    </span>
                {% endif %}
            </div>
        </div>

        <!-- Informations du marchand -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold mb-4">
                <i class="fas fa-user mr-2 text-blue-600"></i>
                Informations du marchand
            </h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-500">Nom complet</p>
                    <p class="font-semibold text-gray-800">{{ payment.merchant.firstname }} {{ payment.merchant.lastname }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Téléphone</p>
                    <p class="font-semibold text-gray-800">{{ payment.merchant.phone }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Email</p>
                    <p class="font-semibold text-gray-800">{{ payment.merchant.email ?? 'Non renseigné' }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Statut du compte</p>
                    <p class="font-semibold">
                        {% if payment.merchant.status.value == 'active' %}
                            <span class="text-green-600">Actif</span>
                        {% else %}
                            <span class="text-yellow-600">En attente</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Détails du paiement -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-semibold mb-4">
                <i class="fas fa-credit-card mr-2 text-purple-600"></i>
                Détails du paiement
            </h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-500">Type</p>
                    <p class="font-semibold text-gray-800">
                        {% if payment.type.value == 'reservation' %}
                            Réservation
                        {% elseif payment.type.value == 'rent' %}
                            Loyer
                        {% elseif payment.type.value == 'guarantee' %}
                            Garantie
                        {% else %}
                            {{ payment.type.value|capitalize }}
                        {% endif %}
                    </p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Date de création</p>
                    <p class="font-semibold text-gray-800">{{ payment.createdAt|date('d/m/Y à H:i') }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Référence transaction</p>
                    <p class="font-semibold text-gray-800 font-mono">{{ payment.bankingTransactionId ?? '-' }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Date de paiement</p>
                    <p class="font-semibold text-gray-800">{{ payment.paymentDate ? payment.paymentDate|date('d/m/Y à H:i') : '-' }}</p>
                </div>
                {% if payment.dueDate %}
                <div>
                    <p class="text-sm text-gray-500">Date d'échéance</p>
                    <p class="font-semibold text-gray-800">{{ payment.dueDate|date('d/m/Y') }}</p>
                </div>
                {% endif %}
                {% if payment.contract %}
                <div>
                    <p class="text-sm text-gray-500">Contrat associé</p>
                    <p class="font-semibold text-gray-800 font-mono">{{ payment.contract.contractCode }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Résumé financier -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-sm p-6 sticky top-6">
            <h3 class="text-lg font-semibold mb-4">
                <i class="fas fa-money-bill-wave mr-2 text-green-600"></i>
                Montant
            </h3>
            
            <div class="text-center py-6 border-b border-gray-200">
                <p class="text-4xl font-bold text-green-600">{{ payment.amount|number_format(0, ',', ' ') }}</p>
                <p class="text-lg text-gray-500">{{ payment.currency }}</p>
            </div>
            
            <div class="mt-4 space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">ID Paiement</span>
                    <span class="font-mono text-xs">{{ payment.id|bin2hex|slice(0, 12)|upper }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Créé le</span>
                    <span>{{ payment.createdAt|date('d/m/Y') }}</span>
                </div>
            </div>

            {% if payment.status.value == 'pending' %}
            <div class="mt-6 pt-4 border-t border-gray-200 space-y-3">
                <form method="post" action="{{ path('market_admin_payments_validate', {id: payment.id|bin2hex}) }}">
                    <input type="hidden" name="_token" value="{{ csrf_token('validate_payment') }}">
                    <button type="submit" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold" onclick="return confirm('Confirmer la validation ?')">
                        <i class="fas fa-check mr-2"></i>Valider ce paiement
                    </button>
                </form>
                <form method="post" action="{{ path('market_admin_payments_reject', {id: payment.id|bin2hex}) }}">
                    <input type="hidden" name="_token" value="{{ csrf_token('reject_payment') }}">
                    <button type="submit" class="w-full px-4 py-3 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-semibold" onclick="return confirm('Rejeter ce paiement ?')">
                        <i class="fas fa-times mr-2"></i>Rejeter
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
